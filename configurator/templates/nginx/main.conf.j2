resolver 1.1.1.1 1.0.0.1;
map_hash_bucket_size 2048;

proxy_ssl_server_name on;
proxy_set_header Host $http_host;
proxy_ssl_name $http_host;

ssl_protocols TLSv1.2;
server_tokens off;

include /etc/nginx/includes/proxy.conf;
include /etc/nginx/includes/headers.conf;

{%- for ip in sorted(dynConfig._ips) %}
set_real_ip_from {{ ip }};
{%- endfor %}

set_real_ip_from 127.0.0.0/8;

set_real_ip_from 10.0.0.0/8;
set_real_ip_from 172.16.0.0/12;
set_real_ip_from 192.168.0.0/16;

real_ip_recursive on;
real_ip_header X-Forwarded-For;

{%- set selfNetwork = dynConfig._find('network') %}

{%- for loc in sorted(dynConfig._locations) %}
upstream location_{{ loc }} {
{%- for server in sorted(dynConfig._locations[loc]) %}
{%- set serverCfg = dynConfig[server] %}
{%- if selfNetwork == serverCfg.network and selfNetwork in serverCfg.networkIp %}
    server {{ serverCfg.networkIp[selfNetwork] }};
{%- else %}
    server {{ serverCfg.primaryIp }};
{%- endif %}
{%- endfor %}
}
{%- endfor %}
